<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××‘×•×š ×”×× ×¨×’×™×” - ××¢×¨×›×ª × ×™×”×•×œ ×–××Ÿ ×—×›××”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, limit, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variable for app logic to access Firebase
        window.firebaseModules = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut,
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            limit,
            where,
            getDocs
        };

        // Dispatch event when modules are ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f4f7f6; }
        
        /* Custom Colors */
        .bg-lion { background-color: #FFB84D; color: #333; }
        .bg-bear { background-color: #8B7355; color: white; }
        .bg-wolf { background-color: #4A4E69; color: white; }
        .bg-dolphin { background-color: #7FB3D5; color: #333; }
        
        .btn-option { transition: all 0.2s ease; }
        .btn-option:active { transform: scale(0.98); }

        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
        
        .prose h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-right: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.3em; }
        .prose strong { font-weight: 700; }
        
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
            40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
            60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);}
            80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white;}
        }

        .task-scroll::-webkit-scrollbar { width: 6px; }
        .task-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .task-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .task-done { text-decoration: line-through; color: #9ca3af; opacity: 0.7; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 bg-gray-100">

    <div class="w-full max-w-lg bg-white rounded-3xl shadow-2xl overflow-hidden min-h-[700px] flex flex-col relative transition-all duration-500" id="main-card">
        
        <!-- Progress Bar -->
        <div class="h-2 bg-gray-100 w-full relative">
            <div id="progress-bar" class="h-full bg-slate-600 transition-all duration-500 ease-out w-0"></div>
        </div>

        <!-- Navigation Controls -->
        <div id="nav-controls" class="absolute top-4 left-4 z-10 hidden">
            <button onclick="goBack()" class="flex items-center text-gray-400 hover:text-gray-600 transition text-sm font-bold">
                <span class="text-lg ml-1">â”</span> ×—×–×•×¨
            </button>
        </div>
        
        <!-- User Profile Indicator -->
        <div id="user-indicator" class="absolute top-4 right-4 z-10 hidden flex flex-col items-end">
             <div class="text-xs text-gray-400">×©×œ×•×, <span id="display-username" class="font-bold"></span></div>
             <button onclick="handleLogout()" class="text-[10px] text-red-300 hover:text-red-500 underline mt-1">×”×ª× ×ª×§ / ×”×—×œ×£ ××©×ª××©</button>
        </div>

        <div class="p-8 flex-grow flex flex-col justify-center">

            <!-- Loading Screen -->
            <div id="screen-loading" class="screen text-center">
                <div class="loader"></div>
                <p class="mt-4 text-gray-500">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
            </div>

            <!-- Login / Name Screen -->
            <div id="screen-login" class="screen hidden text-center">
                <div class="text-6xl mb-4">ğŸ‘‹</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">×‘×¨×•×›×™× ×”×‘××™×</h1>
                <p class="text-gray-600 mb-8">×”×–×Ÿ ××ª ×©××š ×›×“×™ ×œ×™×¦×•×¨ ×¤×¨×•×¤×™×œ ××• ×œ×”×ª×—×‘×¨</p>
                <input type="text" id="username-input" placeholder="×”×©× ×©×œ×š" class="w-full p-4 border rounded-xl mb-4 text-center text-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl hover:bg-indigo-700 transition shadow-lg">
                    ×¦×•×¨ ×¤×¨×•×¤×™×œ ×—×“×© ğŸš€
                </button>
            </div>

            <!-- Welcome Screen (Hub) -->
            <div id="screen-welcome" class="screen hidden text-center">
                <div class="text-6xl mb-4">ğŸ§­</div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">××‘×•×š ×”×× ×¨×’×™×”</h1>
                <h2 class="text-xl text-gray-500 mb-6">××¨×›×– ×”×‘×§×¨×” ×©×œ×š</h2>
                
                <div class="bg-gray-50 p-4 rounded-xl mb-6 border border-gray-100 text-right">
                    <p class="text-sm text-gray-500">×¤×¨×•×¤×™×œ ×‘×¡×™×¡:</p>
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <span id="hub-animal-icon"></span> <span id="hub-animal-name"></span>
                    </h3>
                </div>

                <div class="space-y-4">
                    <button onclick="startQuiz('now')" class="w-full bg-slate-700 text-white font-bold py-4 px-6 rounded-xl hover:bg-slate-800 transition shadow-lg flex items-center justify-between group">
                        <span class="text-right">
                            <div class="text-lg">××” ×”××¦×‘ ×¢×›×©×™×•?</div>
                            <div class="text-xs font-normal opacity-80">×‘×“×™×§×” ×™×•××™×ª ×œ×‘× ×™×™×ª ×œ×•"×– ××•×¤×˜×™××œ×™</div>
                        </span>
                        <span class="text-2xl group-hover:scale-110 transition">âš¡</span>
                    </button>

                    <div class="grid grid-cols-2 gap-3 mt-4">
                         <div class="bg-indigo-50 p-3 rounded-lg text-center">
                             <div class="text-2xl font-bold text-indigo-600" id="stat-tasks-count">0</div>
                             <div class="text-xs text-gray-500">××©×™××•×ª ×¤×ª×•×—×•×ª</div>
                         </div>
                         <div class="bg-teal-50 p-3 rounded-lg text-center">
                             <div class="text-2xl font-bold text-teal-600" id="stat-tasks-done">0</div>
                             <div class="text-xs text-gray-500">×”×•×©×œ××•</div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Pre-Quiz Intro (New Users) -->
            <div id="screen-intro-quiz" class="screen hidden text-center">
                <div class="text-6xl mb-4">ğŸ§¬</div>
                <h1 class="text-2xl font-bold text-gray-800 mb-4">× ×¢×™× ×œ×”×›×™×¨, <span id="intro-name"></span>!</h1>
                <p class="text-gray-600 mb-8 leading-relaxed">
                    ×›×“×™ ×©× ×•×›×œ ×œ×¢×–×•×¨ ×œ×š ×œ× ×”×œ ××ª ×”×–××Ÿ, ×× ×—× ×• ×¦×¨×™×›×™× ×œ×”×‘×™×Ÿ ×§×•×“× ×›×œ ××™ ××ª/×”.
                    <br><br>
                    × ×¦× ×œ"××‘×—×•×Ÿ ×‘×¡×™×¡" ×§×¦×¨ (3 ×©××œ×•×ª) ×©×™×’×œ×” ×œ× ×• ××ª ×”"×—×™×”" ×”×¤× ×™××™×ª ×©×œ×š.
                </p>
                <button onclick="startQuiz('base')" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition shadow-lg">
                    ×”×ª×—×œ ××‘×—×•×Ÿ ×‘×¡×™×¡
                </button>
            </div>

            <!-- Quiz Questions (Base Type) -->
            <!-- Q1 -->
            <div id="screen-q1" class="screen hidden">
                <span class="text-sm font-bold text-gray-400 uppercase tracking-wider">×©××œ×” 1 ××ª×•×š 3</span>
                <h3 class="text-2xl font-bold text-gray-800 mt-2 mb-6">×‘×—×•×¤×© ××•×—×œ×˜, ××ª×™ ×ª×ª×¢×•×¨×¨/×™?</h3>
                <div class="space-y-3">
                    <button onclick="answer('lion')" class="btn-option w-full text-right bg-gray-50 hover:bg-orange-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>×œ×¤× ×™ 06:30 ×‘×‘×•×§×¨</span> <span class="text-2xl">ğŸŒ…</span>
                    </button>
                    <button onclick="answer('bear')" class="btn-option w-full text-right bg-gray-50 hover:bg-amber-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>×‘×™×Ÿ 07:00 ×œ-09:00</span> <span class="text-2xl">â˜€ï¸</span>
                    </button>
                    <button onclick="answer('wolf')" class="btn-option w-full text-right bg-gray-50 hover:bg-indigo-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>××—×¨×™ 10:00 ××• ×‘×¦×”×¨×™×™×</span> <span class="text-2xl">ğŸŒ™</span>
                    </button>
                    <button onclick="answer('dolphin')" class="btn-option w-full text-right bg-gray-50 hover:bg-blue-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>×©×™× ×” ×§×œ×” / × ×“×•×“×™ ×©×™× ×”</span> <span class="text-2xl">ğŸ‘€</span>
                    </button>
                </div>
            </div>

            <!-- Q2 -->
            <div id="screen-q2" class="screen hidden">
                <span class="text-sm font-bold text-gray-400 uppercase tracking-wider">×©××œ×” 2 ××ª×•×š 3</span>
                <h3 class="text-2xl font-bold text-gray-800 mt-2 mb-6">××ª×™ ×”×¨×™×›×•×– ×©×œ×š ×‘×©×™×?</h3>
                <div class="space-y-3">
                    <button onclick="answer('lion')" class="btn-option w-full text-right bg-gray-50 hover:bg-orange-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>××•×§×“× ×‘×‘×•×§×¨</span> <span class="text-2xl">ğŸ¦</span>
                    </button>
                    <button onclick="answer('bear')" class="btn-option w-full text-right bg-gray-50 hover:bg-amber-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>×‘×•×§×¨ ×××•×—×¨ ×¢×“ ×¦×”×¨×™×™×</span> <span class="text-2xl">ğŸ»</span>
                    </button>
                    <button onclick="answer('wolf')" class="btn-option w-full text-right bg-gray-50 hover:bg-indigo-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>×¢×¨×‘ ××• ×œ×™×œ×”</span> <span class="text-2xl">ğŸº</span>
                    </button>
                    <button onclick="answer('dolphin')" class="btn-option w-full text-right bg-gray-50 hover:bg-blue-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>××©×ª× ×” / ×¤×¨×¦×™ ×× ×¨×’×™×”</span> <span class="text-2xl">ğŸ¬</span>
                    </button>
                </div>
            </div>

            <!-- Q3 -->
            <div id="screen-q3" class="screen hidden">
                <span class="text-sm font-bold text-gray-400 uppercase tracking-wider">×©××œ×” 3 ××ª×•×š 3</span>
                <h3 class="text-2xl font-bold text-gray-800 mt-2 mb-6">×‘×™×œ×•×™×™× ×¢×“ ×××•×—×¨?</h3>
                <div class="space-y-3">
                    <button onclick="answer('lion')" class="btn-option w-full text-right bg-gray-50 hover:bg-orange-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>×¢×™×™×£/×” ×‘-21:00</span> <span class="text-2xl">ğŸ˜´</span>
                    </button>
                    <button onclick="answer('bear')" class="btn-option w-full text-right bg-gray-50 hover:bg-amber-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>×¡×‘×‘×”, ××‘×œ ×‘×—×¦×•×ª ×œ×™×©×•×Ÿ</span> <span class="text-2xl">ğŸ˜Œ</span>
                    </button>
                    <button onclick="answer('wolf')" class="btn-option w-full text-right bg-gray-50 hover:bg-indigo-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>×¨×§ ×‘-22:00 ×× ×™ ××ª×¢×•×¨×¨/×ª!</span> <span class="text-2xl">ğŸ”¥</span>
                    </button>
                    <button onclick="answer('dolphin')" class="btn-option w-full text-right bg-gray-50 hover:bg-blue-50 p-4 rounded-xl border border-gray-200 flex items-center justify-between group">
                        <span>××œ×—×™×¥ / ××¢×™×™×£ × ×¤×©×™×ª</span> <span class="text-2xl">ğŸ¤¯</span>
                    </button>
                </div>
            </div>

            <!-- Status Check Screen -->
            <div id="screen-status" class="screen hidden">
                <div class="flex items-center gap-2 mb-4">
                     <span class="text-2xl">âš¡</span>
                     <h3 class="text-xl font-bold text-gray-800">××™×š ××ª/×” ××¨×’×™×©/×” ×›×¨×’×¢?</h3>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="showStatusResult('lion')" class="text-right p-4 rounded-xl border-2 border-orange-100 hover:border-orange-300 hover:bg-orange-50 transition bg-white">
                        <div class="font-bold text-orange-800">×—×“, ×××•×§×“ ×•×—×–×§</div>
                        <div class="text-sm text-gray-600">×©×™× ×”×× ×¨×’×™×” - ×–×” ×”×–××Ÿ ×œ×˜×¨×•×£</div>
                    </button>
                    <button onclick="showStatusResult('bear')" class="text-right p-4 rounded-xl border-2 border-amber-100 hover:border-amber-300 hover:bg-amber-50 transition bg-white">
                        <div class="font-bold text-amber-800">×™×¦×™×‘ ×•×—×‘×¨×•×ª×™</div>
                        <div class="text-sm text-gray-600">×× ×¨×’×™×” ×˜×•×‘×” ×•×××•×–× ×ª</div>
                    </button>
                    <button onclick="showStatusResult('wolf')" class="text-right p-4 rounded-xl border-2 border-indigo-100 hover:border-indigo-300 hover:bg-indigo-50 transition bg-white">
                        <div class="font-bold text-indigo-800">×™×¦×™×¨×ª×™ ××š ××¢×•×¨×¤×œ</div>
                        <div class="text-sm text-gray-600">×¨××© ×¤×ª×•×—, ×¤×—×•×ª ×¤×•×§×•×¡ ×¢×œ ×¤×¨×˜×™×</div>
                    </button>
                    <button onclick="showStatusResult('dolphin')" class="text-right p-4 rounded-xl border-2 border-blue-100 hover:border-blue-300 hover:bg-blue-50 transition bg-white">
                        <div class="font-bold text-blue-800">×œ×—×•×¥ / ×¢×™×™×£ / ××•×¦×£</div>
                        <div class="text-sm text-gray-600">×–×§×•×§ ×œ×”×¤×¡×§×” ××• ××¨×’×•×Ÿ ××—×“×©</div>
                    </button>
                </div>
                 <button onclick="goHome()" class="mt-6 text-gray-400 hover:text-gray-600 text-sm w-full text-center">×‘×™×˜×•×œ ×•×—×–×¨×” ×œ××¡×š ×”×¨××©×™</button>
            </div>

            <!-- Result & Planner Screen -->
            <div id="screen-result" class="screen hidden text-center">
                <div class="flex justify-between items-start">
                    <div id="result-icon" class="text-5xl mb-2 animate-bounce"></div>
                    <div class="text-left">
                        <button onclick="loadLastPlan()" class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded text-white border border-white/40">ğŸ“‚ ×˜×¢×Ÿ ×ª×•×›× ×™×ª ××—×¨×•× ×”</button>
                    </div>
                </div>
                
                <h2 class="text-2xl font-bold mb-1 text-white"><span id="result-title"></span></h2>
                <p id="result-power" class="text-sm text-white/90 mb-4 bg-black/10 p-2 rounded-lg"></p>

                <!-- Tasks & AI Section -->
                <div class="bg-white/95 rounded-t-2xl p-4 shadow-xl min-h-[400px] text-gray-800 text-right">
                    
                    <!-- Task List Header -->
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-700">ğŸ“‹ ××©×™××•×ª ×œ×‘×™×¦×•×¢</h3>
                        <button onclick="toggleAddTask()" class="text-indigo-600 hover:text-indigo-800 text-sm font-bold">+ ×”×•×¡×£</button>
                    </div>

                    <!-- Add Task Form (Toggle) -->
                    <div id="add-task-form" class="hidden bg-indigo-50 p-3 rounded-lg mb-4 border border-indigo-100">
                        <input type="text" id="new-task-desc" placeholder="××” ×”××©×™××”?" class="w-full p-2 text-sm border rounded-lg mb-2">
                        
                        <div class="flex gap-2 mb-2">
                            <select id="new-task-type" class="p-2 text-sm border rounded-lg bg-white flex-1">
                                <option value="short">×§×¦×¨ (×”×™×•×/××—×¨)</option>
                                <option value="long">××¨×•×š (×¤×¨×•×™×§×˜)</option>
                            </select>
                            <input type="text" id="new-task-duration" placeholder="××©×š (×œ××©×œ: ×©×¢×ª×™×™×)" class="w-full p-2 text-sm border rounded-lg flex-1">
                        </div>
                        
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="new-task-recurring" class="w-4 h-4 text-indigo-600 rounded">
                            <label for="new-task-recurring" class="text-sm text-gray-600">××©×™××” ×—×•×–×¨×ª (×”×¨×’×œ)</label>
                        </div>

                        <button onclick="addTask()" class="w-full bg-indigo-600 text-white text-sm py-2 rounded-lg font-bold hover:bg-indigo-700">×©××•×¨ ××©×™××”</button>
                    </div>

                    <!-- Task List Container -->
                    <div id="tasks-container" class="space-y-2 mb-4 max-h-48 overflow-y-auto task-scroll p-1 border rounded bg-gray-50 min-h-[60px]">
                         <p id="empty-task-msg" class="text-xs text-gray-400 text-center py-4">××™×Ÿ ××©×™××•×ª. ×”×•×¡×£ ××©×™××” ×—×“×©×”!</p>
                    </div>

                    <!-- AI Generators -->
                    <div class="border-t pt-4">
                        <h3 class="font-bold text-gray-700 mb-2">âœ¨ ×™×¦×™×¨×ª ×œ×•"×– ×—×›×</h3>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <button onclick="generateSchedule('today')" id="btn-gen-today" class="bg-orange-100 text-orange-700 hover:bg-orange-200 py-2 rounded-lg text-xs font-bold border border-orange-200">
                                ×”×™×•× ğŸŒ™
                            </button>
                            <button onclick="generateSchedule('tomorrow')" id="btn-gen-tomorrow" class="bg-teal-100 text-teal-700 hover:bg-teal-200 py-2 rounded-lg text-xs font-bold border border-teal-200">
                                ××—×¨ â˜€ï¸
                            </button>
                            <button onclick="generateSchedule('week')" id="btn-gen-week" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 py-2 rounded-lg text-xs font-bold border border-indigo-200">
                                ×©×‘×•×¢ ğŸ“…
                            </button>
                        </div>
                    </div>

                    <!-- AI Result Display -->
                    <div id="ai-response-container" class="hidden mt-4 bg-gray-50 p-4 rounded-xl border border-gray-200 text-right">
                        <div class="flex justify-between items-center mb-2 border-b pb-2">
                             <span class="font-bold text-indigo-600 text-sm">×”×ª×•×›× ×™×ª ×©×œ×š:</span>
                             <div class="flex gap-2">
                                <button onclick="saveCurrentPlan()" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">×©××•×¨ ğŸ’¾</button>
                                <button onclick="closeAIResult()" class="text-gray-400 hover:text-gray-600">âœ•</button>
                             </div>
                        </div>
                        <div id="ai-response-text" class="prose text-sm leading-relaxed max-h-60 overflow-y-auto task-scroll"></div>
                    </div>
                </div>

                <div class="mt-4">
                    <button onclick="goHome()" class="bg-black/20 hover:bg-black/30 text-white font-bold py-2 px-6 rounded-xl transition text-sm">
                        ×—×–×¨×” ×œ××¡×š ×”×¨××©×™ ğŸ 
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CONSTANTS & STATE ---
        let apiKey = ""; 
        let firebaseConfig = null;
        let db, auth, userDocRef, tasksColRef, plansColRef;
        let currentUser = null;
        let userData = null;
        let answerHistory = [];
        let currentMode = 'base'; 
        let currentResultType = 'bear'; 
        let unsubscribeTasks = null; // Listener cleanup
        let appId = "default-app-id";

        // --- GITHUB / PUBLIC WEB CONFIGURATION ---
        // Instructions:
        // 1. If you are uploading this to GitHub, replace the Empty Strings below with your keys.
        // 2. You can get firebaseConfig from the Firebase Console (Settings -> General -> Your Apps).
        // 3. You can get Gemini apiKey from aistudio.google.com.
        
        // CHECK IF WE ARE IN THE CANVAS/PREVIEW ENVIRONMENT
        if (typeof __firebase_config !== 'undefined') {
            // WE ARE IN PREVIEW: Use injected keys
            firebaseConfig = JSON.parse(__firebase_config);
            // apiKey is injected by the environment usually, but we check just in case
            if (typeof __app_id !== 'undefined') appId = __app_id;
        } else {
            // WE ARE ON GITHUB/PUBLIC: Use your keys here
            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ PASTE YOUR KEYS HERE ğŸ‘‡ğŸ‘‡ğŸ‘‡
            
            apiKey = ""; // Example: "AIzaSy..."
            
            firebaseConfig = {
                // Paste your Firebase Config Object here
                // apiKey: "...",
                // authDomain: "...",
                // projectId: "...",
                // storageBucket: "...",
                // messagingSenderId: "...",
                // appId: "..."
            };
            
            // ğŸ‘†ğŸ‘†ğŸ‘† END OF KEYS ğŸ‘†ğŸ‘†ğŸ‘†
        }

        const baseData = {
            lion: { title: "××¨×™×” ğŸ¦", name:"××¨×™×”", desc: "××©×›×™××™ ×§×•×, ×—×“×™× ×‘×‘×•×§×¨.", power: "×¢×‘×•×“×” ×¢××•×§×” ×‘×‘×•×§×¨.", class: "bg-lion" },
            bear: { title: "×“×•×‘ ğŸ»", name:"×“×•×‘", desc: "×× ×¨×’×™×” ×™×¦×™×‘×” ×‘×©×¢×•×ª ×”××•×¨.", power: "×©×™×: 10:00-14:00.", class: "bg-bear" },
            wolf: { title: "×–××‘ ğŸº", name:"×–××‘", desc: "×—×™×•×ª ×œ×™×œ×”. ×‘×•×§×¨ ××™×˜×™.", power: "×™×¦×™×¨×ª×™×•×ª ×‘×¢×¨×‘.", class: "bg-wolf" },
            dolphin: { title: "×“×•×œ×¤×™×Ÿ ğŸ¬", name:"×“×•×œ×¤×™×Ÿ", desc: "×©× ×” ×§×œ×”, ××•×— ×¤×¢×™×œ.", power: "×¢×‘×•×“×” ×‘×¡×¤×¨×™× ×˜×™×.", class: "bg-dolphin" }
        };

        const statusData = {
            lion: { title: "××¦×‘ ××¨×™×” (×¤×•×§×•×¡) ğŸ¦", desc: "×—×“×•×ª ×©×™×. ×œ×˜×¨×•×£.", power: "×ª×§×•×£ ××ª ×”××©×™××” ×”×§×©×”.", class: "bg-lion" },
            bear: { title: "××¦×‘ ×“×•×‘ (×™×¦×™×‘×•×ª) ğŸ»", desc: "×× ×¨×’×™×” ×××•×–× ×ª.", power: "×–××Ÿ ×œ×‘×™×¦×•×¢ ×©×•×˜×£.", class: "bg-bear" },
            wolf: { title: "××¦×‘ ×–××‘ (×™×¦×™×¨×”) ğŸº", desc: "×¨××© ×™×¦×™×¨×ª×™ ×•××¢×•×¤×£.", power: "×¡×™×¢×•×¨ ××•×—×•×ª.", class: "bg-wolf" },
            dolphin: { title: "××¦×‘ ×“×•×œ×¤×™×Ÿ (×”×¦×¤×”) ğŸ¬", desc: "×¢×•××¡ ×•×¤×™×–×•×¨.", power: "×¢×¦×•×¨! ×ª×¨×’×™×œ × ×©×™××”.", class: "bg-dolphin" }
        };

        // --- FIREBASE INIT ---
        async function initFirebase() {
            if (window.firebaseModules) { runFirebaseLogic(); } 
            else { window.addEventListener('firebase-ready', runFirebaseLogic); }
        }

        async function runFirebaseLogic() {
            if (!window.firebaseModules) return;
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, collection } = window.firebaseModules;
            
            // Safety check for config
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.warn("No Firebase Config found. If you are on GitHub, please edit index.html and add your keys.");
                if (typeof __firebase_config === 'undefined') {
                    alert("×©×™× ×œ×‘: ×œ× ×”×•×’×“×¨×• ××¤×ª×—×•×ª Firebase. ×”××¤×œ×™×§×¦×™×” ×œ× ×ª×©××•×¨ × ×ª×•× ×™×. × × ×œ×¢×¨×•×š ××ª ×§×•×‘×¥ ×”-HTML ×•×œ×”×•×¡×™×£ ××¤×ª×—×•×ª.");
                }
                return;
            }

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Handle Auth (Preview vs Public)
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                 await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    
                    // Refs
                    userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
                    tasksColRef = collection(db, 'artifacts', appId, 'users', user.uid, 'tasks');
                    plansColRef = collection(db, 'artifacts', appId, 'users', user.uid, 'plans');

                    await checkUserProfile();
                } else {
                    // Logged out
                    showScreen('screen-login');
                    document.getElementById('screen-loading').classList.add('hidden');
                }
            });
        }

        async function checkUserProfile() {
            try {
                const { getDoc } = window.firebaseModules;
                const docSnap = await getDoc(userDocRef);
                document.getElementById('screen-loading').classList.add('hidden');

                if (docSnap.exists()) {
                    userData = docSnap.data();
                    if (userData.name && userData.baseChronotype) {
                        showHub(userData);
                    } else if (userData.name) {
                        showIntroQuiz(userData.name);
                    } else {
                        showScreen('screen-login');
                    }
                } else {
                    showScreen('screen-login');
                }
            } catch (e) {
                console.error("Profile Error:", e);
                showScreen('screen-login');
            }
        }

        async function handleLogin() {
            const name = document.getElementById('username-input').value.trim();
            if (!name) return alert("× × ×œ×”×–×™×Ÿ ×©×");
            const { setDoc } = window.firebaseModules;
            await setDoc(userDocRef, { name: name }, { merge: true });
            if (userData && userData.baseChronotype) showHub({ ...userData, name });
            else showIntroQuiz(name);
        }

        async function handleLogout() {
            if(confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§? ×”××™×“×¢ ×”××§×•××™ ×™× ×•×§×”.')) {
                const { signOut } = window.firebaseModules;
                if (unsubscribeTasks) unsubscribeTasks(); // Detach listener
                await signOut(auth);
                location.reload(); 
            }
        }

        async function saveUserBaseType(type) {
            const { setDoc } = window.firebaseModules;
            await setDoc(userDocRef, { baseChronotype: type }, { merge: true });
            userData = { ...userData, baseChronotype: type };
        }

        // --- HUB & UI ---
        function showHub(data) {
            userData = data;
            document.getElementById('display-username').innerText = data.name;
            document.getElementById('user-indicator').classList.remove('hidden');
            
            if (baseData[data.baseChronotype]) {
                const info = baseData[data.baseChronotype];
                document.getElementById('hub-animal-name').innerText = info.name;
                document.getElementById('hub-animal-icon').innerText = info.title.split(' ')[1];
            }

            // Start listening to tasks stats
            subscribeToTasks(true); 

            showScreen('screen-welcome');
            updateProgress(0);
        }

        function showIntroQuiz(name) {
            document.getElementById('intro-name').innerText = name;
            showScreen('screen-intro-quiz');
        }

        function startQuiz(mode) {
            currentMode = mode;
            answerHistory = []; 
            if (mode === 'base') {
                showScreen('screen-q1');
                updateProgress(10);
                document.getElementById('nav-controls').classList.add('hidden');
            } else {
                showScreen('screen-status');
                updateProgress(50);
                document.getElementById('nav-controls').classList.remove('hidden');
            }
        }

        function goHome() {
            if (userData && userData.baseChronotype) showHub(userData);
            else showScreen('screen-login');
            document.getElementById('nav-controls').classList.add('hidden');
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('fade-enter-active');
            });
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            el.classList.add('fade-enter');
            void el.offsetWidth;
            el.classList.add('fade-enter-active');
        }

        function updateProgress(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        function goBack() {
            if (currentMode === 'now') { goHome(); return; }
            if (answerHistory.length === 0) { goHome(); return; }
            answerHistory.pop();
            const step = answerHistory.length;
            if (step === 0) {
                showScreen('screen-q1');
                updateProgress(10);
                document.getElementById('nav-controls').classList.add('hidden');
            } else if (step === 1) {
                showScreen('screen-q2');
                updateProgress(50);
            }
        }

        // --- QUIZ LOGIC ---
        function answer(type) {
            answerHistory.push(type);
            const step = answerHistory.length;
            if (step >= 1) document.getElementById('nav-controls').classList.remove('hidden');
            if (step === 1) { showScreen('screen-q2'); updateProgress(50); }
            else if (step === 2) { showScreen('screen-q3'); updateProgress(90); }
            else { calculateBaseResult(); }
        }

        function calculateBaseResult() {
            updateProgress(100);
            document.getElementById('nav-controls').classList.add('hidden');
            const counts = { lion: 0, bear: 0, wolf: 0, dolphin: 0 };
            answerHistory.forEach(a => counts[a]++);
            let winner = 'bear'; let maxVal = -1;
            for (const [key, val] of Object.entries(counts)) { if (val > maxVal) { maxVal = val; winner = key; } }
            saveUserBaseType(winner);
            currentResultType = winner; 
            renderResult(winner, baseData[winner]);
        }

        function showStatusResult(type) {
            updateProgress(100);
            document.getElementById('nav-controls').classList.add('hidden');
            currentResultType = type;
            renderResult(type, statusData[type]);
        }

        function renderResult(type, data) {
            const resultScreen = document.getElementById('screen-result');
            resultScreen.className = `screen rounded-2xl shadow-inner fade-enter fade-enter-active ${data.class}`;
            
            document.getElementById('result-title').innerText = data.title;
            document.getElementById('result-icon').innerText = data.title.includes('ğŸ¦') ? 'ğŸ¦' : data.title.includes('ğŸ»') ? 'ğŸ»' : data.title.includes('ğŸº') ? 'ğŸº' : 'ğŸ¬';
            document.getElementById('result-power').innerText = data.power;

            document.getElementById('add-task-form').classList.add('hidden');
            document.getElementById('ai-response-container').classList.add('hidden');
            
            // Switch to tasks listener for full view
            subscribeToTasks(false);

            showScreen('screen-result');
        }

        // --- TASKS LOGIC (FIRESTORE) ---
        function subscribeToTasks(statsOnly) {
            const { onSnapshot, query, orderBy } = window.firebaseModules;
            if (unsubscribeTasks) unsubscribeTasks();

            const q = query(tasksColRef, orderBy('createdAt', 'desc'));
            
            unsubscribeTasks = onSnapshot(q, (snapshot) => {
                const tasks = [];
                let doneCount = 0;
                snapshot.forEach(doc => {
                    const t = { id: doc.id, ...doc.data() };
                    tasks.push(t);
                    if (t.completed) doneCount++;
                });

                if (statsOnly) {
                    document.getElementById('stat-tasks-count').innerText = tasks.length - doneCount;
                    document.getElementById('stat-tasks-done').innerText = doneCount;
                } else {
                    renderTaskList(tasks);
                }
            });
        }

        async function addTask() {
            const desc = document.getElementById('new-task-desc').value.trim();
            const duration = document.getElementById('new-task-duration').value.trim();
            const type = document.getElementById('new-task-type').value;
            const recurring = document.getElementById('new-task-recurring').checked;
            const { addDoc, serverTimestamp } = window.firebaseModules;

            if (!desc) return alert('× × ×œ×”×–×™×Ÿ ×ª×™××•×¨');

            await addDoc(tasksColRef, {
                desc, duration, type, recurring,
                completed: false,
                createdAt: serverTimestamp()
            });

            document.getElementById('new-task-desc').value = '';
            document.getElementById('new-task-duration').value = '';
            documentyId('new-task-recurring').checked = false;
            toggleAddTask(); // Close form
        }

        async function toggleTaskDone(id, currentStatus) {
            const { updateDoc, doc } = window.firebaseModules;
            const taskRef = doc(tasksColRef, id);
            await updateDoc(taskRef, { completed: !currentStatus });
        }

        async function deleteTask(id) {
            if(!confirm('×œ××—×•×§?')) return;
            const { deleteDoc, doc } = window.firebaseModules;
             deleteDoc(doc(tasksColRef, id));
        }

        function renderTaskList(tasks) {
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';
            
            if (tasks.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 text-center py-4">××™×Ÿ ××©×™××•×ª.</p>';
                return;
            }

            tasks.forEach(task => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between bg-white p-2 rounded border border-gray-100 text-sm mb-1 ${task.completed ? 'bg-gray-50' : ''}`;
                
                const recIcon = task.recurring ? 'ğŸ”' : '';
                const typeIcon = task.type === 'long' ? 'ğŸ“…' : 'â±ï¸';
                const doneClass = task.completed ? 'task-done' : 'font-bold text-gray-900';
                
                div.innerHTML = `
                    <div class="flex items-center gap-2 f overflow-hidden">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskDone('${task.id}', ${task.completed})" class="w-4 h-4 cursor-pointer">
                        <div class="flex-grow">
                            <div class="${doneClass} truncate">${recIcon} ${task.desc}</div>
                            <div class="text-[10px] text-gray-500">${typeIcon} ${task.duration || ''}</div>
                        </div>
                    </div>
                    <button onclick="deleteTask('${task.id}')" class="text-gray-300 hover:text-red-400 px-2">âœ•</button>
                `;
                container.appendChild(div);
            });
        }

        function toggleAddTask() {
            const form = document.getElementById('add-task-form');
            form.classList.toggle('hidden');
        }

        // --- PLANNER LOGIC ---

        async function generateSchedule(timeframe) {
            const btnId = timeframe === 'today' ? 'btn-gen-today' : imeframe === 'tomorrow' ? 'btn-gen-tomorrow' : 'btn-gen-week');
            const btn = document.getElementById(btnId);
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="loading-dots">..</span>`;
            
            // Get open tasks
            const { getDocs, query, where } = window.firebaseModules;
            const q = query(tasksColRef, where("completed", "==", false));
            const snapshot = await getDocs(q);
            const tasks = [];
            snapshot.forEach(d => tasks.push(d.data()));

            if (tasks.length === 0) {
                alert("×›×œ ×”××©×™××•×ª ×”×•×©×œ××•! ×”×•×¡×£ ××©×™××•×ª ×—×“×©×•×ª ×›×“×™ ×œ×ª×›× ×Ÿ.");
                btn.innerHTML = originalText;
                return;
            }

            const taskListString = tasks.map(t => `- ${t.desc} [${t.type}, ${t.recurring ? 'RECURRING' : 'ONCE'}]`).join('\n');
            const typeForPrompt = currentResultType;
            const context = "Current Status: " + rPrompt;

            const prompt = `
                Act as a Chronobiology Coach.
                User: "${typeForPrompt}" (${context}).
                Goal: Plan for ${timeframe}.
                
                Tasks:
                ${taskListString}
                
                Rules:
                - Lion: Mornings.
                - Bear: 10am-2pm.
                - Wolf: Evening.
                - Dolphin: Short bursts.
                - RECURRING tasks: Suggest habit stacking.
                
                Output: Hebrew. HTML bullet points.
            `;

            try {
                const response = await callGeminiAPI(prompt);
                const htmlContent = marked.parse(response);
                document.getElementById('ai-response-text').innerHTML = htmlContent;
                document.getElementById('ai-response-container').classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert("×©×’×™××” ×‘×ª×§×©×•×¨×ª");
  finally {
                btn.innerHTML = originalText;
            }
        }

        async function saveCurrentPlan() {
            const content = document.getElementById('ai-response-text').innerHTML;
            if(!content) return;
            const { addDoc, serverTimestamp } = window.firebaseModules;
            await addDoc(plansColRef, {
                html: content,
                createdAt: serverTimestamp()
            });
            alert("×”×ª×•×›× ×™×ª × ×©××¨×” ×‘×”×¦×œ×—×”!");
        }

        async function loadLastPlan() {
            const { getDocs, query, orderBy, limit } = window.firebaseModules;
            const q = query(plansColRef, orderBy('createdAt', 'desc'), limit(1));
            const snap = await getDocs(q);
            if(snap.empty) { alert("×œ× × ××¦××” ×ª×•×›× ×™×ª ×©××•×¨×”"); return; }
            
            const plan = snap.docs[0].data();
            document.getElementById('ai-response-text').innerHTML = plan.html;
            documtElementById('ai-response-container').classList.remove('hidden');
        }

        function closeAIResult() {
            document.getElementById('ai-response-container').classList.add('hidden');
        }

        async function callGeminiAPI(prompt) {
            // Check for API Key
            if (!apiKey) {
                alert("×—×¡×¨ ××¤×ª×— API. ×× ××ª×” ×‘-GitHub, × × ×œ×”×•×¡×™×£ ××•×ª×• ×‘×§×•×‘×¥ ×”-HTML.");
                return "Error: No API Key";
            }
            
         `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        initFirebase();
    </script>
</body>
</html>
